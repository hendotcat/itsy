---

.part-of-app-build: &part-of-app-build
  only:
    changes:
      - editor/**/*
      - itsy/**/*
      - manual/**/*
      - studio/**/*

stages:
  - build
  - deploy

build:itsy:
  stage: build
  image: highvalleysystems/itsy:latest
  <<: *part-of-app-build
  script:
    - cd itsy
    - yarn --pure-lockfile
    - make itsy
    - cd ../editor
    - yarn --pure-lockfile
    - yarn build
    - cd ../manual
    - yarn --pure-lockfile
    - yarn build
  artifacts:
    paths:
      - editor/webviews/index.html
      - manual/webviews/index.html

deploy:studio:
  stage: deploy
  image: node:12-stretch
  dependencies:
    - build:itsy
  before_script:
    - echo fs.inotify.max_user_instances=524288 | tee -a /etc/sysctl.conf && sysctl -p
    - echo fs.inotify.max_user_watches=524288   | tee -a /etc/sysctl.conf && sysctl -p
    - echo fs.inotify.max_queued_events=524288  | tee -a /etc/sysctl.conf && sysctl -p
    - ls editor/webviews
    - ls manual/webviews
    - cp editor/webviews/index.html studio/assets/weviews/editor.html
    - cd studio
  <<: *part-of-app-build
  script:
    - yarn --pure-lockfile
    - yarn expo login -u $EXPO_USERNAME -p $EXPO_PASSWORD
    - yarn expo publish --non-interactive
  
deploy:website:
  stage: deploy
  image: node:12-stretch
  before_script:
    - cd website
  only:
    changes:
      - website/**/*
  script:
    - yarn --pure-lockfile
    - yarn gatsby build
    - yarn netlify deploy --prod --dir=public --site $NETLIFY_SITE_ID --auth $NETLIFY_AUTH_TOKEN
